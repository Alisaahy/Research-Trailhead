<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Research Discovery Agent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles following 8pt spacing system and design requirements */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        /* Hide scrollbars but keep functionality */
        ::-webkit-scrollbar {
            width: 0px;
            background: transparent;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #fdfbfb 0%, #f7f9fc 100%);
        }

        .card-shadow {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.06);
        }

        .card-shadow-hover:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08), 0 2px 4px rgba(0, 0, 0, 0.08);
        }

        /* Drag and drop zone */
        .drop-zone {
            transition: all 0.2s ease;
        }

        .drop-zone.drag-over {
            border-color: #2d3748;
            background-color: #f7fafc;
        }

        /* Stars for rating */
        .star-rating {
            display: inline-flex;
            gap: 4px;
        }

        .star {
            width: 16px;
            height: 16px;
        }

        /* Progress bar animation */
        @keyframes progress {
            0% { width: 0%; }
        }

        .animate-progress {
            animation: progress 0.5s ease-out;
        }

        /* Fade in animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- Main Container -->
    <div class="max-w-4xl mx-auto px-16 py-24">
        <!-- Header -->
        <header class="mb-32 text-center fade-in">
            <h1 class="text-32 font-semibold text-gray-900 mb-8" style="line-height: 40px;">
                Research Discovery Agent
            </h1>
            <p class="text-16 text-gray-600" style="line-height: 24px;">
                Upload a paper and discover viable, novel research directions
            </p>
        </header>

        <!-- Upload Section -->
        <div id="upload-section" class="mb-32">
            <div class="bg-white rounded-16 p-24 card-shadow">
                <!-- File Upload -->
                <div class="mb-24">
                    <label class="block text-16 font-medium text-gray-900 mb-8" style="line-height: 24px;">
                        Upload Research Paper
                    </label>
                    <div id="drop-zone" class="drop-zone border-2 border-dashed border-gray-300 rounded-12 p-32 text-center cursor-pointer">
                        <svg class="mx-auto h-48 w-48 text-gray-400 mb-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        <p class="text-16 text-gray-600 mb-4" style="line-height: 24px;">
                            Drag and drop your PDF here, or click to browse
                        </p>
                        <p class="text-14 text-gray-500" style="line-height: 20px;">
                            PDF files up to 50MB
                        </p>
                        <input type="file" id="file-input" accept=".pdf" class="hidden">
                    </div>
                    <p id="file-name" class="text-14 text-gray-600 mt-8" style="line-height: 20px; display: none;"></p>
                </div>

                <!-- Topic Selection -->
                <div class="mb-24">
                    <label class="block text-16 font-medium text-gray-900 mb-8" style="line-height: 24px;">
                        Select Research Topics (choose at least 1)
                    </label>
                    <div id="topics-grid" class="grid grid-cols-2 gap-8">
                        <!-- Topics will be populated here -->
                    </div>
                </div>

                <!-- Analyze Button -->
                <button id="analyze-btn" disabled class="w-full h-48 bg-gray-900 text-white text-16 font-medium rounded-8 hover:bg-gray-800 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors" style="line-height: 24px;">
                    Analyze Paper
                </button>
            </div>
        </div>

        <!-- Processing Section -->
        <div id="processing-section" class="mb-32" style="display: none;">
            <div class="bg-white rounded-16 p-24 card-shadow">
                <div class="text-center mb-16">
                    <div class="inline-block animate-spin rounded-full h-32 w-32 border-4 border-gray-200 border-t-gray-900 mb-16"></div>
                    <p id="status-text" class="text-16 text-gray-900 font-medium mb-4" style="line-height: 24px;">
                        Processing...
                    </p>
                    <p class="text-14 text-gray-600" style="line-height: 20px;">
                        This may take 5-10 minutes
                    </p>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-8">
                    <div id="progress-bar" class="bg-gray-900 h-8 rounded-full transition-all animate-progress" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results-section" style="display: none;">
            <!-- Paper Summary -->
            <div class="bg-white rounded-16 p-24 card-shadow mb-24 fade-in">
                <h2 class="text-20 font-semibold text-gray-900 mb-12" style="line-height: 28px;">
                    Paper Summary
                </h2>
                <p id="paper-summary" class="text-16 text-gray-700" style="line-height: 24px;">
                </p>
            </div>

            <!-- Top 3 Ideas -->
            <div class="mb-16">
                <h2 class="text-24 font-semibold text-gray-900 mb-16" style="line-height: 32px;">
                    Top 3 Research Ideas
                </h2>
            </div>

            <div id="ideas-container" class="space-y-16">
                <!-- Ideas will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = 'http://localhost:5001/api';
        let currentJobId = null;
        let uploadedFile = null;

        // Predefined topics
        const TOPICS = [
            'Machine Learning',
            'Natural Language Processing',
            'Computer Vision',
            'Robotics',
            'Healthcare',
            'Climate Science',
            'Neuroscience',
            'Data Science',
            'Quantum Computing',
            'Bioinformatics'
        ];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initializeTopics();
            initializeFileUpload();
            initializeAnalyzeButton();
        });

        function initializeTopics() {
            const grid = document.getElementById('topics-grid');
            TOPICS.forEach(topic => {
                const label = document.createElement('label');
                label.className = 'flex items-center gap-8 p-12 border-2 border-gray-200 rounded-8 cursor-pointer hover:border-gray-400 transition-colors';
                label.innerHTML = `
                    <input type="checkbox" class="topic-checkbox w-20 h-20 rounded border-gray-300" value="${topic}">
                    <span class="text-14 text-gray-900" style="line-height: 20px;">${topic}</span>
                `;
                grid.appendChild(label);
            });
        }

        function initializeFileUpload() {
            const dropZone = document.getElementById('drop-zone');
            const fileInput = document.getElementById('file-input');

            dropZone.addEventListener('click', () => fileInput.click());

            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-over');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('drag-over');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });
        }

        async function handleFile(file) {
            if (file.type !== 'application/pdf') {
                alert('Please upload a PDF file');
                return;
            }

            if (file.size > 50 * 1024 * 1024) {
                alert('File size must be under 50MB');
                return;
            }

            // Show file name
            document.getElementById('file-name').textContent = `Selected: ${file.name}`;
            document.getElementById('file-name').style.display = 'block';

            // Upload file
            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch(`${API_BASE}/upload`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) throw new Error('Upload failed');

                const data = await response.json();
                currentJobId = data.job_id;
                uploadedFile = file;

                // Enable analyze button if topics selected
                updateAnalyzeButton();
            } catch (error) {
                alert('Failed to upload file. Please try again.');
                console.error(error);
            }
        }

        function initializeAnalyzeButton() {
            const analyzeBtn = document.getElementById('analyze-btn');
            const checkboxes = document.querySelectorAll('.topic-checkbox');

            checkboxes.forEach(cb => {
                cb.addEventListener('change', updateAnalyzeButton);
            });

            analyzeBtn.addEventListener('click', startAnalysis);
        }

        function updateAnalyzeButton() {
            const analyzeBtn = document.getElementById('analyze-btn');
            const selectedTopics = getSelectedTopics();

            analyzeBtn.disabled = !(currentJobId && selectedTopics.length > 0);
        }

        function getSelectedTopics() {
            const checkboxes = document.querySelectorAll('.topic-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        async function startAnalysis() {
            const topics = getSelectedTopics();

            // Hide upload section, show processing
            document.getElementById('upload-section').style.display = 'none';
            document.getElementById('processing-section').style.display = 'block';

            try {
                // Phase 1: Quick read
                const readResponse = await fetch(`${API_BASE}/analyze/read`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        job_id: currentJobId,
                        topics: topics
                    })
                });

                if (!readResponse.ok) throw new Error('Quick read failed');
                const readData = await readResponse.json();

                // Phase 2: Auto-select first 3 ideas and start deep search
                const ideas = readData.ideas || [];
                const selectedIndices = ideas.slice(0, 3).map((_, i) => i); // Select first 3 ideas

                const searchResponse = await fetch(`${API_BASE}/analyze/search`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        job_id: currentJobId,
                        selected_ideas: selectedIndices
                    })
                });

                if (!searchResponse.ok) throw new Error('Deep search failed');

                // Poll for status
                pollStatus();
            } catch (error) {
                alert('Failed to start analysis. Please try again.');
                console.error(error);
                document.getElementById('upload-section').style.display = 'block';
                document.getElementById('processing-section').style.display = 'none';
            }
        }

        async function pollStatus() {
            const interval = setInterval(async () => {
                try {
                    const response = await fetch(`${API_BASE}/status/${currentJobId}`);
                    const data = await response.json();

                    // Update progress
                    updateProgress(data.status, data.progress);

                    if (data.status === 'complete') {
                        clearInterval(interval);
                        await loadResults();
                    } else if (data.status === 'error') {
                        clearInterval(interval);
                        alert('Analysis failed: ' + (data.error || 'Unknown error'));
                        document.getElementById('upload-section').style.display = 'block';
                        document.getElementById('processing-section').style.display = 'none';
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                }
            }, 2000);
        }

        function updateProgress(status, progress) {
            const statusText = document.getElementById('status-text');
            const progressBar = document.getElementById('progress-bar');

            const statusMessages = {
                'parsing': 'Reading paper...',
                'reading': 'Extracting concepts and generating ideas...',
                'ideas_ready': 'Initial ideas ready, starting deep research...',
                'searching': 'Researching literature and ranking ideas...',
                'complete': 'Complete!'
            };

            statusText.textContent = statusMessages[status] || 'Processing...';
            progressBar.style.width = `${progress}%`;
        }

        async function loadResults() {
            try {
                const response = await fetch(`${API_BASE}/results/${currentJobId}`);
                const data = await response.json();

                // Hide processing, show results
                document.getElementById('processing-section').style.display = 'none';
                document.getElementById('results-section').style.display = 'block';

                // Display paper summary
                document.getElementById('paper-summary').textContent = data.paper_summary;

                // Display ideas
                displayIdeas(data.ideas);
            } catch (error) {
                alert('Failed to load results');
                console.error(error);
            }
        }

        function displayIdeas(ideas) {
            const container = document.getElementById('ideas-container');
            container.innerHTML = '';

            ideas.forEach((item, index) => {
                const ideaCard = createIdeaCard(item, index + 1);
                container.appendChild(ideaCard);
            });
        }

        function createIdeaCard(item, rank) {
            const idea = item.idea;
            const novelty = item.novelty_assessment;
            const doability = item.doability_assessment;
            const synthesis = item.literature_synthesis;

            const card = document.createElement('div');
            card.className = 'bg-white rounded-16 p-24 card-shadow card-shadow-hover fade-in';

            card.innerHTML = `
                <div class="flex items-start gap-16 mb-16">
                    <div class="flex-shrink-0 w-32 h-32 rounded-full bg-gray-900 text-white flex items-center justify-center text-16 font-semibold">
                        ${rank}
                    </div>
                    <div class="flex-1">
                        <h3 class="text-20 font-semibold text-gray-900 mb-8" style="line-height: 28px;">
                            ${idea.title}
                        </h3>
                        <p class="text-16 text-gray-700 mb-12" style="line-height: 24px;">
                            ${idea.description}
                        </p>
                        <div class="flex gap-16 flex-wrap">
                            <div class="flex items-center gap-8">
                                <span class="text-14 text-gray-600" style="line-height: 20px;">Novelty:</span>
                                ${createStars(novelty.novelty_score)}
                            </div>
                            <div class="flex items-center gap-8">
                                <span class="text-14 text-gray-600" style="line-height: 20px;">Doability:</span>
                                ${createStars(doability.doability_score)}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="space-y-16 pt-16 border-t border-gray-200">
                    <div>
                        <h4 class="text-16 font-semibold text-gray-900 mb-8" style="line-height: 24px;">Why This Idea?</h4>
                        <p class="text-14 text-gray-700" style="line-height: 20px;">${idea.rationale}</p>
                    </div>

                    <div>
                        <h4 class="text-16 font-semibold text-gray-900 mb-8" style="line-height: 24px;">Research Landscape</h4>
                        <p class="text-14 text-gray-700 mb-8" style="line-height: 20px;">${synthesis.overview}</p>
                        <p class="text-14 text-gray-600" style="line-height: 20px;"><strong>Gap:</strong> ${synthesis.whats_missing}</p>
                    </div>

                    <div>
                        <h4 class="text-16 font-semibold text-gray-900 mb-8" style="line-height: 24px;">Suggested Approach</h4>
                        <p class="text-14 text-gray-700" style="line-height: 20px;">${synthesis.suggested_approach}</p>
                    </div>

                    <div>
                        <h4 class="text-16 font-semibold text-gray-900 mb-8" style="line-height: 24px;">Key References</h4>
                        <ul class="space-y-4">
                            ${item.papers.slice(0, 5).map(paper => `
                                <li class="text-14 text-gray-700" style="line-height: 20px;">
                                    <a href="${paper.url}" target="_blank" class="hover:text-gray-900">
                                        ${paper.title} (${paper.year})
                                    </a>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                </div>
            `;

            return card;
        }

        function createStars(score) {
            const fullStars = Math.floor(score);
            const emptyStars = 5 - fullStars;
            let html = '<div class="star-rating">';

            for (let i = 0; i < fullStars; i++) {
                html += '<svg class="star text-gray-900" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>';
            }

            for (let i = 0; i < emptyStars; i++) {
                html += '<svg class="star text-gray-300" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>';
            }

            html += '</div>';
            return html;
        }
    </script>
</body>
</html>
