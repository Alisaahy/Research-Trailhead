<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Research Trailhead</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'sage': {
                            50: '#f6f7f6',
                            100: '#e3e7e2',
                            200: '#c7cfc5',
                            300: '#a4b0a1',
                            400: '#8B9D83',
                            500: '#6d7d68',
                            600: '#596554',
                            700: '#495244',
                            800: '#3d4439',
                            900: '#343a31'
                        }
                    },
                    spacing: {
                        '4': '4px',
                        '8': '8px',
                        '16': '16px',
                        '24': '24px',
                        '32': '32px',
                        '40': '40px',
                        '48': '48px',
                        '56': '56px',
                        '64': '64px'
                    }
                }
            }
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #FFFFFF;
            color: #111827;
            line-height: 1.5;
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
            padding: 32px 16px;
        }

        .section {
            background: #FFFFFF;
            border: 2px solid #8B9D83;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(139, 157, 131, 0.1);
            transition: opacity 0.3s ease, transform 0.3s ease;
            scroll-margin-top: 32px;
        }

        .btn {
            width: 100%;
            height: 48px;
            background: #8B9D83;
            color: #FFFFFF;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .btn:hover:not(:disabled) {
            background: #6d7d68;
        }

        .btn:disabled {
            background: #c7cfc5;
            color: #596554;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #596554;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #495244;
        }

        .input,
        .select,
        .textarea {
            width: 100%;
            background: #FFFFFF;
            border: 1px solid #8B9D83;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 16px;
            line-height: 24px;
            transition: border 0.2s ease;
        }

        .input:focus,
        .select:focus,
        .textarea:focus {
            outline: none;
            border: 2px solid #6d7d68;
            padding: 11px 15px;
        }

        .textarea {
            resize: vertical;
            min-height: 96px;
        }

        .label {
            display: block;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #111827;
        }

        .field {
            margin-bottom: 24px;
        }


        .card {
            background: #FFFFFF;
            border: 1px solid #8B9D83;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .card-result {
            background: #f6f7f6;
            border: 1px solid #c7cfc5;
            border-radius: 8px;
            padding: 16px;
        }

        .badge {
            display: inline-block;
            background: #e3e7e2;
            color: #343a31;
            border: 1px solid #8B9D83;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .idea-checkbox-container {
            display: flex;
            align-items: start;
            gap: 12px;
            background: #F9FAFB;
            border: 1px solid #D1D5DB;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .idea-checkbox-container:hover {
            background: #F3F4F6;
            border-color: #6B7280;
        }

        .idea-checkbox-container.selected {
            background: #E5E7EB;
            border-color: #000000;
            border-width: 2px;
            padding: 15px;
        }

        .checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #000000;
            border-radius: 4px;
            cursor: pointer;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .final-idea-card {
            background: #FFFFFF;
            border: 2px solid #000000;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .score-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin: 16px 0;
        }

        .score-box {
            background: #F9FAFB;
            border: 1px solid #D1D5DB;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }

        .score-label {
            font-size: 12px;
            color: #6B7280;
            margin-bottom: 4px;
        }

        .score-value {
            font-size: 24px;
            font-weight: 700;
            color: #000000;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #D1D5DB;
            border-top-color: #000000;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .alert {
            background: #F3F4F6;
            border: 1px solid #6B7280;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .alert-error {
            background: #FEE2E2;
            border-color: #DC2626;
            color: #991B1B;
        }

        .alert-success {
            background: #E5E7EB;
            border-color: #000000;
            color: #111827;
        }

        h1 {
            font-size: 32px;
            line-height: 40px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        h2 {
            font-size: 24px;
            line-height: 32px;
            font-weight: 700;
            margin-bottom: 16px;
        }

        h3 {
            font-size: 20px;
            line-height: 32px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .text-sm {
            font-size: 14px;
            line-height: 24px;
        }

        .text-xs {
            font-size: 12px;
            line-height: 16px;
        }

        .mono {
            font-family: 'Monaco', 'Courier New', monospace;
        }

        .fade-in {
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .reference-item {
            background: #F9FAFB;
            border-left: 2px solid #000000;
            padding: 8px 12px;
            margin-bottom: 8px;
            font-size: 12px;
            line-height: 16px;
        }

        .rank-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            background: #000000;
            color: #FFFFFF;
            border-radius: 50%;
            font-weight: 700;
            font-size: 16px;
            margin-right: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header style="margin-bottom: 32px;">
            <h1>Research Trailhead</h1>
            <p class="text-sm" style="color: #6B7280;">Turn papers into research opportunities</p>
        </header>

        <!-- Step 1: User Profile -->
        <section id="section-1" class="section">
            <h2>Step 1: Create Your Profile</h2>

            <div class="field">
                <label class="label">Profile Method</label>
                <select id="profile-method" class="select" onchange="toggleProfileMethod()">
                    <option value="manual">Manual Description</option>
                    <option value="scholar">Google Scholar URL</option>
                </select>
            </div>

            <div id="manual-section">
                <div class="field">
                    <label class="label">Research Description</label>
                    <textarea
                        id="profile-description"
                        class="textarea"
                        placeholder="Describe your research interests, background, and experience..."
                    ></textarea>
                </div>

                <div class="field">
                    <label class="label">Experience Level</label>
                    <select id="experience-level" class="select">
                        <option value="">Auto-detect</option>
                        <option value="Undergraduate Student">Undergraduate Student</option>
                        <option value="PhD Student">PhD Student</option>
                        <option value="Postdoc">Postdoc</option>
                        <option value="Assistant Professor">Assistant Professor</option>
                        <option value="Associate/Full Professor">Associate/Full Professor</option>
                        <option value="Industry Researcher">Industry Researcher</option>
                    </select>
                </div>
            </div>

            <div id="scholar-section" class="hidden">
                <div class="field">
                    <label class="label">Google Scholar URL</label>
                    <input
                        type="text"
                        id="scholar-url"
                        class="input"
                        placeholder="https://scholar.google.com/citations?user=..."
                    >
                </div>
            </div>

            <button onclick="createProfile()" class="btn">Create Profile</button>

            <div id="profile-result" class="card-result hidden fade-in" style="margin-top: 24px;">
                <h3>Profile Created</h3>
                <div style="margin-top: 16px;">
                    <div style="margin-bottom: 8px;">
                        <span class="text-sm" style="font-weight: 600;">User ID:</span>
                        <span id="user-id" class="text-sm mono" style="color: #6B7280;"></span>
                    </div>
                    <div style="margin-bottom: 8px;">
                        <span class="text-sm" style="font-weight: 600;">Experience Level:</span>
                        <span id="profile-level" class="text-sm"></span>
                    </div>
                    <div style="margin-bottom: 8px;">
                        <span class="text-sm" style="font-weight: 600;">Research Areas:</span>
                        <div id="profile-areas" style="margin-top: 8px;"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Step 2: Upload Paper -->
        <section id="section-2" class="section">
            <h2>Step 2: Upload Paper</h2>

            <div class="field">
                <label class="label">PDF File</label>
                <input
                    type="file"
                    id="pdf-file"
                    accept=".pdf"
                    class="input"
                >
            </div>

            <div class="field">
                <label class="label">Research Topics (from your profile)</label>
                <div id="auto-topics" style="min-height: 40px;">
                    <span class="text-sm" style="color: #6B7280;">Topics will appear here after profile creation</span>
                </div>
            </div>

            <div class="field">
                <label class="label">Additional Topics (Optional)</label>
                <input
                    type="text"
                    id="manual-topics"
                    class="input"
                    placeholder="Graph Neural Networks, Attention Mechanisms, ..."
                >
                <p class="text-xs" style="color: #6B7280; margin-top: 8px;">Comma-separated list of additional topics</p>
            </div>

            <button onclick="uploadAndAnalyze()" class="btn" id="upload-btn">Upload & Analyze</button>

            <div id="upload-status" class="alert hidden" style="margin-top: 24px;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span class="loading"></span>
                    <span id="status-text" class="text-sm font-weight: 600;"></span>
                </div>
                <p class="text-xs" style="color: #6B7280; margin-top: 8px;">
                    Job ID: <span id="job-id" class="mono"></span>
                </p>
            </div>
        </section>

        <!-- Step 3: Quick Read Results -->
        <section id="section-3" class="section">
            <h2>Step 3: Quick Read Results</h2>

            <div style="margin-bottom: 24px;">
                <h3>Paper Summary</h3>
                <div id="paper-summary" class="card-result text-sm"></div>
            </div>

            <div style="margin-bottom: 24px;">
                <h3>Key Concepts</h3>
                <div id="concepts-list"></div>
            </div>

            <div style="margin-bottom: 24px;">
                <h3>Research Ideas (Select 3)</h3>
                <div id="ideas-list"></div>
            </div>

            <button onclick="researchSelectedIdeas()" class="btn" id="research-btn" disabled>
                Research Selected Ideas (5-10 minutes)
            </button>

            <div id="research-status" class="alert hidden" style="margin-top: 24px;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span class="loading"></span>
                    <span class="text-sm" style="font-weight: 600;">Deep research in progress...</span>
                </div>
                <p class="text-xs" style="color: #6B7280; margin-top: 8px;">This may take 5-10 minutes</p>
            </div>
        </section>

        <!-- Step 4: (Combined with Step 3) -->

        <!-- Step 5: Final Results -->
        <section id="section-5" class="section">
            <h2>Step 5: Final Ranked Ideas</h2>
            <div id="final-ideas-list"></div>
        </section>
    </div>

    <script>
        // Global state
        let currentUserId = null;
        let currentJobId = null;
        let currentStep = 1;
        let allIdeas = [];
        let selectedIdeas = [];

        // API base URL
        const API_BASE = 'http://localhost:5001';

        // Step management
        function setStep(step) {
            currentStep = step;

            // Scroll to the section
            const activeSection = document.getElementById(`section-${step}`);
            if (activeSection) {
                setTimeout(() => {
                    activeSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            }
        }

        // Toggle profile method
        function toggleProfileMethod() {
            const method = document.getElementById('profile-method').value;
            const manualSection = document.getElementById('manual-section');
            const scholarSection = document.getElementById('scholar-section');

            if (method === 'manual') {
                manualSection.classList.remove('hidden');
                scholarSection.classList.add('hidden');
            } else {
                manualSection.classList.add('hidden');
                scholarSection.classList.remove('hidden');
            }
        }

        // Step 1: Create Profile
        async function createProfile() {
            const method = document.getElementById('profile-method').value;
            let payload = { method };

            if (method === 'manual') {
                const description = document.getElementById('profile-description').value.trim();
                const experienceLevel = document.getElementById('experience-level').value;

                if (!description) {
                    showError('Please enter a research description');
                    return;
                }

                payload.description = description;
                if (experienceLevel) payload.experience_level = experienceLevel;
            } else {
                const scholarUrl = document.getElementById('scholar-url').value.trim();
                if (!scholarUrl) {
                    showError('Please enter a Google Scholar URL');
                    return;
                }
                payload.google_scholar_url = scholarUrl;
            }

            try {
                const response = await fetch(`${API_BASE}/api/users/profile`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (response.ok) {
                    currentUserId = data.user_id;

                    // Display profile result
                    document.getElementById('profile-result').classList.remove('hidden');
                    document.getElementById('user-id').textContent = data.user_id;
                    document.getElementById('profile-level').textContent = data.profile.expertise_level || 'N/A';

                    // Display research areas as badges
                    const areasDiv = document.getElementById('profile-areas');
                    areasDiv.innerHTML = '';
                    (data.profile.research_areas || []).forEach(area => {
                        const badge = document.createElement('span');
                        badge.className = 'badge';
                        badge.textContent = area;
                        areasDiv.appendChild(badge);
                    });

                    // Auto-generate topics from profile
                    displayAutoTopics(data.profile);

                    // Move to step 2
                    setStep(2);
                } else {
                    showError(data.error || 'Failed to create profile');
                }
            } catch (error) {
                showError(`Error: ${error.message}`);
            }
        }

        // Display auto-detected topics
        function displayAutoTopics(profile) {
            const autoTopicsDiv = document.getElementById('auto-topics');
            autoTopicsDiv.innerHTML = '';

            const topics = [
                ...(profile.research_areas || []),
                ...(profile.specific_topics || []).slice(0, 3)
            ];

            if (topics.length === 0) {
                autoTopicsDiv.innerHTML = '<span class="text-sm" style="color: #6B7280;">No topics detected</span>';
                return;
            }

            topics.forEach(topic => {
                const badge = document.createElement('span');
                badge.className = 'badge';
                badge.textContent = topic;
                autoTopicsDiv.appendChild(badge);
            });
        }

        // Get all topics (auto + manual)
        function getAllTopics() {
            const autoTopicsDiv = document.getElementById('auto-topics');
            const autoTopics = Array.from(autoTopicsDiv.querySelectorAll('.badge')).map(el => el.textContent);

            const manualTopicsInput = document.getElementById('manual-topics').value;
            const manualTopics = manualTopicsInput
                ? manualTopicsInput.split(',').map(t => t.trim()).filter(t => t)
                : [];

            return [...new Set([...autoTopics, ...manualTopics])];
        }

        // Step 2: Upload and Analyze
        async function uploadAndAnalyze() {
            const fileInput = document.getElementById('pdf-file');

            if (!currentUserId) {
                showError('Please create a profile first');
                return;
            }

            if (!fileInput.files[0]) {
                showError('Please select a PDF file');
                return;
            }

            const topics = getAllTopics();
            if (topics.length === 0) {
                showError('No topics available. Please create a profile or add manual topics.');
                return;
            }

            // Show loading state
            document.getElementById('upload-btn').disabled = true;
            document.getElementById('upload-status').classList.remove('hidden');
            document.getElementById('status-text').textContent = 'Uploading PDF...';

            try {
                // Upload PDF
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                formData.append('user_id', currentUserId);

                const uploadResponse = await fetch(`${API_BASE}/api/upload`, {
                    method: 'POST',
                    body: formData
                });

                const uploadData = await uploadResponse.json();

                if (!uploadResponse.ok) {
                    throw new Error(uploadData.error || 'Upload failed');
                }

                currentJobId = uploadData.job_id;
                document.getElementById('job-id').textContent = currentJobId;
                document.getElementById('status-text').textContent = 'Analyzing paper (1-2 minutes)...';

                // Start quick read
                const analyzeResponse = await fetch(`${API_BASE}/api/analyze/read`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        job_id: currentJobId,
                        topics: topics
                    })
                });

                const analyzeData = await analyzeResponse.json();

                if (!analyzeResponse.ok) {
                    throw new Error(analyzeData.error || 'Analysis failed');
                }

                // Display results
                displayQuickReadResults(analyzeData);
                document.getElementById('upload-status').classList.add('hidden');
                document.getElementById('upload-btn').disabled = false;
                setStep(3);

            } catch (error) {
                showError(`Error: ${error.message}`);
                document.getElementById('upload-status').classList.add('hidden');
                document.getElementById('upload-btn').disabled = false;
            }
        }

        // Display Quick Read Results
        function displayQuickReadResults(data) {
            // Summary
            document.getElementById('paper-summary').textContent = data.summary || 'No summary available';

            // Concepts
            const conceptsList = document.getElementById('concepts-list');
            conceptsList.innerHTML = '';
            (data.concepts || []).forEach(concept => {
                const badge = document.createElement('span');
                badge.className = 'badge';
                badge.textContent = concept;
                conceptsList.appendChild(badge);
            });

            // Ideas
            allIdeas = data.ideas || [];
            const ideasList = document.getElementById('ideas-list');
            ideasList.innerHTML = '';

            allIdeas.forEach((idea, index) => {
                const container = document.createElement('div');
                container.className = 'idea-checkbox-container';
                container.onclick = () => toggleIdeaSelection(index);

                container.innerHTML = `
                    <input type="checkbox" id="idea-${index}" class="checkbox" onclick="event.stopPropagation();" onchange="toggleIdeaSelection(${index})">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; margin-bottom: 8px;">${idea.title || `Idea ${index + 1}`}</div>
                        <div class="text-sm" style="color: #374151;">${idea.description || ''}</div>
                    </div>
                `;

                ideasList.appendChild(container);
            });
        }

        // Toggle idea selection
        function toggleIdeaSelection(index) {
            const checkbox = document.getElementById(`idea-${index}`);
            checkbox.checked = !checkbox.checked;

            updateIdeaSelection();
        }

        // Update idea selection
        function updateIdeaSelection() {
            selectedIdeas = [];

            allIdeas.forEach((idea, index) => {
                const checkbox = document.getElementById(`idea-${index}`);
                const container = checkbox.closest('.idea-checkbox-container');

                if (checkbox.checked) {
                    selectedIdeas.push(index);
                    container.classList.add('selected');
                } else {
                    container.classList.remove('selected');
                }
            });

            // Enforce 3-idea limit
            if (selectedIdeas.length > 3) {
                const lastIndex = selectedIdeas[selectedIdeas.length - 1];
                const lastCheckbox = document.getElementById(`idea-${lastIndex}`);
                lastCheckbox.checked = false;
                lastCheckbox.closest('.idea-checkbox-container').classList.remove('selected');
                selectedIdeas.pop();
                showError('Please select exactly 3 ideas');
            }

            // Enable/disable research button
            const researchBtn = document.getElementById('research-btn');
            researchBtn.disabled = selectedIdeas.length !== 3;
        }

        // Research Selected Ideas
        async function researchSelectedIdeas() {
            if (selectedIdeas.length !== 3) {
                showError('Please select exactly 3 ideas');
                return;
            }

            // Show loading state
            document.getElementById('research-btn').disabled = true;
            document.getElementById('research-status').classList.remove('hidden');

            try {
                const response = await fetch(`${API_BASE}/api/analyze/search`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        job_id: currentJobId,
                        selected_ideas: selectedIdeas
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Research failed');
                }

                // Display final results
                displayFinalResults(data.top_ideas);
                document.getElementById('research-status').classList.add('hidden');
                setStep(5);

            } catch (error) {
                showError(`Error: ${error.message}`);
                document.getElementById('research-status').classList.add('hidden');
                document.getElementById('research-btn').disabled = false;
            }
        }

        // Display Final Results
        function displayFinalResults(topIdeas) {
            const finalList = document.getElementById('final-ideas-list');
            finalList.innerHTML = '';

            topIdeas.forEach((idea, index) => {
                const card = document.createElement('div');
                card.className = 'final-idea-card fade-in';

                const refs = (idea.references || []).slice(0, 5);
                const refHtml = refs.length > 0
                    ? refs.map(ref => `
                        <div class="reference-item">
                            <div style="font-weight: 600; margin-bottom: 4px;">${ref.title || 'No title'}</div>
                            <div class="text-xs" style="color: #6B7280;">
                                ${ref.year || 'N/A'} â€¢ ${ref.citation_count || 0} citations
                            </div>
                        </div>
                    `).join('')
                    : '<p class="text-sm" style="color: #6B7280;">No references available</p>';

                card.innerHTML = `
                    <div style="display: flex; align-items: center; margin-bottom: 16px;">
                        <span class="rank-badge">${index + 1}</span>
                        <h3 style="margin: 0; flex: 1;">${idea.title}</h3>
                        <div style="background: #000000; color: #FFFFFF; padding: 8px 16px; border-radius: 8px; font-weight: 700;">
                            ${idea.composite_score}/5
                        </div>
                    </div>

                    <p class="text-sm" style="margin-bottom: 16px; color: #374151;">${idea.description}</p>

                    <div class="score-grid">
                        <div class="score-box">
                            <div class="score-label">Novelty</div>
                            <div class="score-value">${idea.novelty_score}/5</div>
                        </div>
                        <div class="score-box">
                            <div class="score-label">Doability</div>
                            <div class="score-value">${idea.doability_score}/5</div>
                        </div>
                        <div class="score-box">
                            <div class="score-label">Topic Match</div>
                            <div class="score-value">${idea.topic_match_score}/5</div>
                        </div>
                    </div>

                    <div class="card-result" style="margin-bottom: 16px;">
                        <div style="font-weight: 600; margin-bottom: 8px;">Rationale</div>
                        <p class="text-sm">${idea.rationale || 'N/A'}</p>
                    </div>

                    <div>
                        <div style="font-weight: 600; margin-bottom: 12px;">Key References</div>
                        ${refHtml}
                    </div>
                `;

                finalList.appendChild(card);
            });
        }

        // Error handling
        function showError(message) {
            alert(message);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setStep(1);
        });
    </script>
</body>
</html>
